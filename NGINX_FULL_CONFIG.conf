# ПОЛНАЯ КОНФИГУРАЦИЯ NGINX ДЛЯ ISPmanager
# Скопируйте каждый блок в соответствующий раздел в ISPmanager

# ============================================
# БЛОК 1: HTTP (порт 80)
# ============================================
# Вставьте в ISPmanager: WWW → Домены → game.dekan.pro → Настройки → Дополнительные директивы nginx
# ЗАМЕНИТЕ весь HTTP блок (server { ... }) на этот:

server {
	server_name game.dekan.pro www.game.dekan.pro;
	charset UTF-8;
	index index.php index.html;
	disable_symlinks if_not_owner from=$root_path;
	include /etc/nginx/vhosts-includes/*.conf;
	include /etc/nginx/vhosts-resources/game.dekan.pro/*.conf;
	include /etc/nginx/users-resources/www-root/*.conf;
	access_log /var/www/httpd-logs/game.dekan.pro.access.log;
	error_log /var/www/httpd-logs/game.dekan.pro.error.log notice;
	ssi on;
	set $root_path /var/www/www-root/data/www/game.dekan.pro;
	root $root_path;
	listen 82.146.39.18:80;
	gzip on;
	gzip_comp_level 5;
	gzip_disable "msie6";
	gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;
	
	# WebSocket для Socket.io - ДОЛЖЕН БЫТЬ ПЕРВЫМ!
	location /socket.io/ {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
		proxy_read_timeout 86400;
		access_log off;
	}

	# API запросы
	location /api/ {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
	}

	# Админ-панель
	location /admin {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
		proxy_cache_bypass $http_upgrade;
	}

	# Статические файлы админ-панели
	location ~ ^/(admin\.js|style\.css)$ {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
	}

	# Статические файлы - отдаем напрямую
	location ~* ^.+\.(jpg|jpeg|gif|png|svg|js|css|mp3|ogg|mpe?g|avi|zip|gz|bz2?|rar|swf|webp|woff|woff2)$ {
		expires 24h;
		try_files $uri =404;
	}

	# Все остальное - через Node.js
	location / {
		try_files $uri $uri/ @fallback;
	}

	location @fallback {
		include /etc/nginx/vhosts-resources/game.dekan.pro/dynamic/*.conf;
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_redirect http://unix:/var/www/www-root/data/nodejs/0.sock /;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
		access_log off;
	}
}

# ============================================
# БЛОК 2: HTTPS (порт 443)
# ============================================
# Вставьте в ISPmanager: WWW → Домены → game.dekan.pro → Настройки → Дополнительные директивы nginx
# ЗАМЕНИТЕ весь HTTPS блок (server { ... }) на этот:

server {
	server_name game.dekan.pro www.game.dekan.pro;
	ssl_certificate "/var/www/httpd-cert/www-root/game.dekan.pro_le1.crtca";
	ssl_certificate_key "/var/www/httpd-cert/www-root/game.dekan.pro_le1.key";
	ssl_ciphers EECDH:+AES256:-3DES:RSA+AES:!NULL:!RC4;
	ssl_prefer_server_ciphers on;
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
	ssl_dhparam /etc/ssl/certs/dhparam4096.pem;
	charset UTF-8;
	index index.php index.html;
	disable_symlinks if_not_owner from=$root_path;
	include /etc/nginx/vhosts-includes/*.conf;
	include /etc/nginx/vhosts-resources/game.dekan.pro/*.conf;
	include /etc/nginx/users-resources/www-root/*.conf;
	access_log /var/www/httpd-logs/game.dekan.pro.access.log;
	error_log /var/www/httpd-logs/game.dekan.pro.error.log notice;
	ssi on;
	set $root_path /var/www/www-root/data/www/game.dekan.pro;
	root $root_path;
	listen 82.146.39.18:443 ssl;
	gzip on;
	gzip_comp_level 5;
	gzip_disable "msie6";
	gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;
	
	# WebSocket для Socket.io - ДОЛЖЕН БЫТЬ ПЕРВЫМ!
	location /socket.io/ {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
		proxy_read_timeout 86400;
		access_log off;
	}

	# API запросы
	location /api/ {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
	}

	# Админ-панель
	location /admin {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
		proxy_cache_bypass $http_upgrade;
	}

	# Статические файлы админ-панели
	location ~ ^/(admin\.js|style\.css)$ {
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
	}

	# Статические файлы - отдаем напрямую
	location ~* ^.+\.(jpg|jpeg|gif|png|svg|js|css|mp3|ogg|mpe?g|avi|zip|gz|bz2?|rar|swf|webp|woff|woff2)$ {
		expires 24h;
		try_files $uri =404;
	}

	# Все остальное - через Node.js
	location / {
		try_files $uri $uri/ @fallback;
	}

	location @fallback {
		include /etc/nginx/vhosts-resources/game.dekan.pro/dynamic/*.conf;
		proxy_pass http://unix:/var/www/www-root/data/nodejs/0.sock;
		proxy_redirect http://unix:/var/www/www-root/data/nodejs/0.sock /;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Port $server_port;
		access_log off;
	}
}
